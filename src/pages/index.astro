---
import BaseLayout from '@/layouts/BaseLayout.astro';
import WorkCard from '@/components/WorkCard.astro';
import '@/styles/library.css';
import { getCollection } from 'astro:content';

const allWorks = await getCollection('works', ({ data }) => data.status === 'published');
const recentWorks = allWorks.sort((a, b) => b.data.publishedDate.getTime() - a.data.publishedDate.getTime()).slice(0, 12);

const genreCounts = allWorks.reduce<Record<string, number>>((acc, w) => {
  acc[w.data.genre] = (acc[w.data.genre] || 0) + 1;
  return acc;
}, {});

const genres = Object.entries(genreCounts).map(([name, count]) => ({
  name: name.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
  slug: name,
  count,
})).sort((a, b) => a.name.localeCompare(b.name));
---

<BaseLayout title="Home">
  <div class="container">
    <section class="hero">
      <h1>Must Read</h1>
      <p>A curated library of original short fiction and creative nonfiction. Every piece combines the styles of two authors with the structural DNA of two canonical works. Free to read. Optimized for reading.</p>
      <p class="hero__stats">{allWorks.length.toLocaleString()} works across {genres.length} genres</p>
    </section>

    {genres.length > 0 && (
      <section>
        <h2>Browse by Genre</h2>
        <div class="genre-grid">
          {genres.map(g => (
            <a href={`${import.meta.env.BASE_URL}browse/${g.slug}/`} class="genre-card">
              <div class="genre-card__name">{g.name}</div>
              <div class="genre-card__count">{g.count} works</div>
            </a>
          ))}
        </div>
      </section>
    )}

    {recentWorks.length > 0 && (
      <section>
        <h2>Recently Published</h2>
        <div class="library-grid">
          {recentWorks.map(w => (
            <WorkCard
              title={w.data.title}
              slug={w.data.slug}
              genre={w.data.genre}
              subgenre={w.data.subgenre}
              rating={w.data.rating}
              readingTimeMinutes={w.data.readingTimeMinutes}
              synopsis={w.data.synopsis}
            />
          ))}
        </div>
      </section>
    )}
  </div>
</BaseLayout>

<style>
  .hero {
    padding: 3rem 0 2rem;
    max-width: 60ch;
  }
  .hero h1 {
    font-size: clamp(2rem, 1.5rem + 2vw, 3.5rem);
    font-weight: 700;
    letter-spacing: -0.03em;
    margin-bottom: 1rem;
  }
  .hero p {
    font-size: 1.1rem;
    line-height: 1.6;
    color: var(--color-text-secondary);
  }
  .hero__stats {
    margin-top: 0.5rem;
    font-weight: 500;
    color: var(--color-text);
  }
  section {
    margin-bottom: 3rem;
  }
  section h2 {
    margin-bottom: 1rem;
  }
</style>
