---
import ReadingLayout from '@/layouts/ReadingLayout.astro';
import ReviewCard from '@/components/ReviewCard.astro';
import StarRating from '@/components/StarRating.astro';
import { getCollection } from 'astro:content';
import { render } from 'astro:content';

export async function getStaticPaths() {
  const works = await getCollection('works');
  return works.map(work => ({
    params: { slug: work.data.slug },
    props: { work },
  }));
}

const { work } = Astro.props;
const { Content } = await render(work);

const allReviews = await getCollection('reviews');
const workReviews = allReviews.find(r => r.data.workSlug === work.data.slug);

const allPersonas = await getCollection('personas');
const personaMap = new Map<string, string>();
allPersonas.forEach(p => {
  personaMap.set(p.data.id, p.data.name);
});
---

<ReadingLayout
  title={work.data.title}
  genre={work.data.genre}
  subgenre={work.data.subgenre}
  authorA={work.data.authorA}
  authorB={work.data.authorB}
  workX={work.data.workX}
  workY={work.data.workY}
  publishedDate={work.data.publishedDate}
>
  <Content />

  <div slot="reviews">
    <h2>Reader Reviews</h2>
    <hr class="reviews-divider" />
    <div class="reviews-summary">
      <StarRating rating={work.data.rating} count={work.data.ratingCount} size="lg" />
    </div>

    {workReviews && [...workReviews.data.reviews].sort((a, b) => b.helpfulCount - a.helpfulCount).map(review => (
      <ReviewCard
        personaName={personaMap.get(review.personaId) || review.personaId}
        personaId={review.personaId}
        rating={review.rating}
        text={review.text}
        date={review.date.toISOString().split('T')[0]}
        helpfulCount={review.helpfulCount}
      />
    ))}

    <div class="formula-card">
      <h3>The Formula</h3>
      <div class="formula-card__grid">
        <div class="formula-card__item">
          <span class="formula-card__label">Author A</span>
          <span class="formula-card__value">{work.data.authorA}</span>
          <ul>
            {work.data.combination.fromAuthorA.map(item => <li>{item}</li>)}
          </ul>
        </div>
        <div class="formula-card__item">
          <span class="formula-card__label">Author B</span>
          <span class="formula-card__value">{work.data.authorB}</span>
          <ul>
            {work.data.combination.fromAuthorB.map(item => <li>{item}</li>)}
          </ul>
        </div>
        <div class="formula-card__item">
          <span class="formula-card__label">Work X</span>
          <span class="formula-card__value">{work.data.workX}</span>
          <ul>
            {work.data.combination.fromWorkX.map(item => <li>{item}</li>)}
          </ul>
        </div>
        <div class="formula-card__item">
          <span class="formula-card__label">Work Y</span>
          <span class="formula-card__value">{work.data.workY}</span>
          <ul>
            {work.data.combination.fromWorkY.map(item => <li>{item}</li>)}
          </ul>
        </div>
      </div>
    </div>
  </div>
</ReadingLayout>

<style>
  .reviews-summary {
    margin-bottom: var(--space-xl);
  }

  .formula-card {
    margin-top: var(--space-2xl);
    padding: var(--space-xl);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
  }

  .formula-card h3 {
    font-family: var(--font-display);
    margin-bottom: var(--space-lg);
    font-size: 1.3rem;
  }

  .formula-card__grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--space-lg);
  }

  @media (min-width: 640px) {
    .formula-card__grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .formula-card__item {
    padding: var(--space-md);
    background: var(--color-surface-raised);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
  }

  .formula-card__label {
    font-family: var(--font-ui);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-accent);
    display: block;
    margin-bottom: 0.2rem;
  }

  .formula-card__value {
    font-family: var(--font-display);
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--color-text);
    display: block;
    margin-bottom: var(--space-sm);
  }

  .formula-card__item ul {
    padding-left: 1.25rem;
    font-family: var(--font-ui);
    font-size: 0.82rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
  }

  .formula-card__item li {
    margin-bottom: 0.2rem;
  }
</style>
